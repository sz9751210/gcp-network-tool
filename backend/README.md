# GCP Network Planner - Backend

[English](README.md) | [繁體中文](README_zh-TW.md)

The backend service for GCP Network Planner, built with **FastAPI** and **Python 3.11**. It handles GCP API interactions, network scanning, data persistence, and analytical tasks.

## Architecture

### Core Components

- **`main.py`**: The FastAPI application entry point. Defines all HTTP endpoints.
- **`gcp_scanner.py`**: The main orchestrator for network scans. It uses `ThreadPoolExecutor` to parallelize scans across projects.
- **`scan_manager.py`**: Manages scan state (running, completed, failed) and persistence (saving results to `data/` directory).
- **`credentials_manager.py`**: Handles storage and activation of GCP Service Account keys.
- **`scanners/`**: Modular scanner implementations:
  - `network_scanner.py`: VPCs, Subnets, Routes.
  - `gke_scanner.py`: Clusters, Node Pools, Workloads.
  - `instance_scanner.py`: GCE Instances.
  - `firewall_scanner.py`: Firewall rules and Cloud Armor policies.
  - `storage_scanner.py`: Cloud Storage buckets.

### Data Storage

- **Scan Results**: Stored as JSON files in the local `data/` directory.
- **Credentials**: Stored securely in `credentials/` (excluded from git).
- **Persistence**: No external database is required by default; it uses a file-based system for simplicity and portability.

## API Endpoints

Documentation is auto-generated by FastAPI. Once running, visit:
**[http://localhost:8000/docs](http://localhost:8000/docs)**

### Key Endpoints

- **Scan Operations**:
  - `POST /api/scan`: Start a new scan (accepts granular `scan_options`).
  - `GET /api/scan/{id}/status`: Poll scan progress.
  - `GET /api/scan/{id}/results`: Retrieve full topology.

- **Resources**:
  - `GET /api/resources/gke-clusters`: List all found GKE clusters.
  - `GET /api/resources/public-ips`: List all external IPs.
  - `GET /api/networks`: Get the latest complete network topology.

- **Analysis tools**:
  - `POST /api/check-cidr`: Check for CIDR conflicts.
  - `POST /api/plan-ip`: Suggest available CIDRs.

## Development

### Running Locally

1. **Install Dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

2. **Run Server**:
   ```bash
   uvicorn main:app --reload --host 0.0.0.0 --port 8000
   ```

### Adding a New Scanner

1. Create a new scanner class in `scanners/` (e.g., `redis_scanner.py`).
2. Instantiate it in `GCPScanner.__init__`.
3. Add a submit task in `GCPScanner._scan_single_project` within the thread pool.
4. Collect results and add them to the `Project` model in `models.py`.
